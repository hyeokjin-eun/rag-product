# Spec 생성 커맨드

도메인의 상세 스펙 문서를 생성하고 품질을 검증합니다. 이 문서는 `/feature` 커맨드 실행 시 참조됩니다.

## 입력

- $ARGUMENTS: 도메인 이름 (예: documents, search, embeddings, rag)

## 작업 흐름

```
[1. 기존 스펙 확인]
        ↓
[2. 요구사항 수집]
        ↓
[3. 스펙 문서 작성]
        ↓
[4. 에이전트 분석] ─────────────────────┐
        │                              │
        ├─→ 🔍 risk-analyst           │  병렬 실행
        ├─→ 🔒 security-analyst       │
        └─→ 🧪 test-designer          │
        ↓  ←───────────────────────────┘
[5. 분석 결과 통합]
        ↓
┌─────────────────────────┐
│  [6. 품질 검증]          │
│        ↓                │
│  부족한 부분 있음?        │ ←──────┐
│     ↓ Yes               │        │
│  [7. 피드백 & 보완]  ─────┼────────┘
│     ↓ No                │
└─────────────────────────┘
        ↓
[8. 완료]
```

## 사용 에이전트

| 에이전트 | 파일 | 역할 |
|----------|------|------|
| Risk Analyst | `agents/risk-analyst.md` | 리스크/장애 분석 → 스펙 8장 |
| Security Analyst | `agents/security-analyst.md` | 보안 검토 → 스펙 8.3장, 4.2장 |
| Test Designer | `agents/test-designer.md` | 테스트 설계 → 스펙 9장 |

---

## 작업 순서

### 1. 기존 스펙 확인

`.claude/specs/$ARGUMENTS.md` 파일이 이미 존재하는지 확인하세요.
- 존재하면: 수정할지 새로 작성할지 사용자에게 질문
- 없으면: 새로 생성 진행

### 2. 프로젝트 컨텍스트 확인

`.claude/CLAUDE.md`를 읽고 프로젝트 전체 구조와 기술 스택을 파악하세요.

### 3. 상세 요구사항 수집

사용자에게 다음 질문들을 **단계별로** 진행하세요. 한 번에 모든 질문을 하지 말고, 각 섹션별로 충분히 깊게 파고드세요.

#### 3.1 도메인 개요
- 이 도메인($ARGUMENTS)의 핵심 역할은 무엇인가요?
- 어떤 문제를 해결하나요?
- 이 도메인의 경계(boundary)는 어디까지인가요?

#### 3.2 데이터 모델
- 핵심 엔티티(Entity)는 무엇인가요?
- 각 엔티티의 필드와 타입을 알려주세요
- 필수 필드와 선택 필드를 구분해주세요
- 필드별 제약조건이 있나요? (최대 길이, 포맷, 범위 등)
- 엔티티 간 관계가 있나요?

#### 3.3 API 엔드포인트
각 엔드포인트별로 상세히 질문:
- 어떤 HTTP 메서드와 경로인가요?
- 요청 파라미터/바디는 무엇인가요?
- 응답 형식은 어떻게 되나요?
- 인증/권한이 필요한가요?
- 페이지네이션이 필요한가요?
- 필터링/정렬 옵션이 있나요?

#### 3.4 비즈니스 로직
- 핵심 비즈니스 규칙은 무엇인가요?
- 데이터 검증 규칙이 있나요?
- 상태 변화(state machine)가 있나요?
- 트랜잭션 처리가 필요한 작업이 있나요?

#### 3.5 외부 연동
- 다른 도메인과 어떻게 연동하나요?
- 외부 서비스(Qdrant, OpenAI 등) 연동이 필요한가요?
- Temporal 워크플로우가 필요한가요? 어떤 작업을 비동기로 처리하나요?

#### 3.6 에러 처리
- 발생 가능한 에러 케이스는 무엇인가요?
- 각 에러별 HTTP 상태 코드와 메시지는?
- 재시도 정책이 필요한 작업이 있나요?

#### 3.7 성능/확장성
- 예상 트래픽/데이터 규모는?
- 캐싱이 필요한가요?
- 배치 처리가 필요한 작업이 있나요?
- 동시성 제어가 필요한가요?

### 4. 스펙 문서 작성

수집한 정보를 바탕으로 `.claude/specs/$ARGUMENTS.md` 파일을 아래 템플릿에 맞춰 작성하세요.

---

## 스펙 문서 템플릿

```markdown
# {도메인명} 도메인 스펙

## 1. 개요

### 1.1 목적
{이 도메인이 해결하는 문제와 핵심 역할}

### 1.2 책임 범위
{이 도메인이 담당하는 것과 담당하지 않는 것}

### 1.3 용어 정의
| 용어 | 정의 |
|------|------|
| {용어1} | {설명} |

---

## 2. 데이터 모델

### 2.1 엔티티: {엔티티명}

#### 필드 정의
| 필드명 | 타입 | 필수 | 설명 | 제약조건 |
|--------|------|------|------|----------|
| id | string | O | 고유 식별자 | UUID v4 |
| {필드} | {타입} | O/X | {설명} | {제약조건} |

#### 상태 다이어그램 (해당시)
```
{상태1} → {상태2} → {상태3}
              ↓
          {상태4}
```

### 2.2 엔티티 관계
```
{엔티티A} 1:N {엔티티B}
```

---

## 3. API 명세

### 3.1 엔드포인트 목록
| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| POST | /api/v1/{도메인} | 생성 | 필요 |
| GET | /api/v1/{도메인}/{id} | 단일 조회 | 필요 |

### 3.2 상세 명세

#### POST /api/v1/{도메인}
{엔드포인트 설명}

**Request**
```json
{
  "field1": "string (필수, 최대 200자)",
  "field2": "number (선택, 기본값: 0)"
}
```

**Response 201**
```json
{
  "id": "uuid",
  "field1": "string",
  "created_at": "2024-01-01T00:00:00Z"
}
```

**Errors**
| 상태코드 | 코드 | 메시지 | 상황 |
|----------|------|--------|------|
| 400 | INVALID_INPUT | 잘못된 입력입니다 | 필수 필드 누락 |
| 409 | DUPLICATE | 이미 존재합니다 | 중복 생성 시도 |

---

## 4. 비즈니스 로직

### 4.1 핵심 규칙
1. {규칙1 설명}
2. {규칙2 설명}

### 4.2 검증 규칙
| 필드 | 규칙 | 에러 메시지 |
|------|------|-------------|
| {필드} | {규칙} | {메시지} |

### 4.3 프로세스 흐름
```
1. {단계1}
   ↓
2. {단계2}
   ↓
3. {단계3}
```

---

## 5. 외부 연동

### 5.1 도메인 의존성
| 연동 도메인 | 연동 방식 | 용도 |
|-------------|-----------|------|
| embeddings | 서비스 호출 | 벡터 생성 |

### 5.2 인프라 연동
| 서비스 | 용도 | 비고 |
|--------|------|------|
| Qdrant | 벡터 저장/검색 | |

### 5.3 Temporal 워크플로우 (해당시)
| 워크플로우 | 트리거 | 처리 내용 |
|------------|--------|-----------|
| {이름} | {트리거조건} | {설명} |

---

## 6. 에러 처리

### 6.1 에러 코드 정의
| 코드 | HTTP | 메시지 | 설명 | 대응 |
|------|------|--------|------|------|
| DOCUMENT_NOT_FOUND | 404 | 문서를 찾을 수 없습니다 | ID로 조회 실패 | - |

### 6.2 재시도 정책
| 작업 | 최대 재시도 | 간격 | 조건 |
|------|-------------|------|------|
| {작업} | 3회 | 지수 백오프 | {조건} |

---

## 7. 비기능 요구사항

### 7.1 성능
- 예상 처리량: {TPS}
- 응답 시간 목표: {ms}

### 7.2 확장성
- {확장성 관련 요구사항}

### 7.3 캐싱 (해당시)
| 대상 | TTL | 무효화 조건 |
|------|-----|-------------|
| {대상} | {시간} | {조건} |

---

## 8. 리스크 및 장애 대응

### 8.1 식별된 리스크
| 리스크 | 영향도 | 발생 가능성 | 대응 방안 |
|--------|--------|-------------|-----------|
| {리스크1} | 상/중/하 | 상/중/하 | {대응} |

### 8.2 장애 포인트
| 장애 포인트 | 증상 | 탐지 방법 | 복구 방법 |
|-------------|------|-----------|-----------|
| {외부 API 장애} | {타임아웃} | {헬스체크} | {서킷브레이커} |

### 8.3 보안 고려사항
| 위협 | 대응 방안 | 구현 위치 |
|------|-----------|-----------|
| {인젝션 공격} | {입력 검증} | {service.py} |

### 8.4 장애 복구 절차
```
1. {장애 탐지}
   ↓
2. {원인 파악}
   ↓
3. {복구 조치}
   ↓
4. {정상화 확인}
```

---

## 9. 테스트 시나리오

### 9.1 단위 테스트
| 테스트 케이스 | 입력 | 기대 결과 |
|---------------|------|-----------|
| {케이스1} | {입력} | {결과} |

### 9.2 통합 테스트
| 시나리오 | 단계 | 검증 항목 |
|----------|------|-----------|
| {시나리오1} | {단계} | {검증} |

### 9.3 장애 시나리오 테스트
| 시나리오 | 장애 조건 | 기대 동작 |
|----------|-----------|-----------|
| {외부 API 다운} | {연결 실패} | {폴백 응답} |

---

## 10. 구현 체크리스트

### 10.1 필수 구현
- [ ] 스키마 정의 (schemas.py)
- [ ] 서비스 구현 (service.py)
- [ ] 레포지토리 구현 (repository.py)
- [ ] API 라우터 구현 (api/v1/{도메인}.py)
- [ ] 의존성 주입 설정 (dependencies.py)
- [ ] 에러 핸들링 구현
- [ ] 단위 테스트 작성
- [ ] 통합 테스트 작성

### 10.2 리스크 대응 구현
- [ ] 입력 검증 로직
- [ ] 서킷브레이커 (해당시)
- [ ] 재시도 로직 (해당시)
- [ ] 타임아웃 설정
- [ ] 로깅/모니터링

### 10.3 Temporal (해당시)
- [ ] 워크플로우 정의
- [ ] 액티비티 구현
- [ ] 워커 등록
```

---

## 5. 품질 검증 (검증-보완 루프)

스펙 문서 작성 후, 다음 체크리스트로 품질을 검증하세요.
**부족한 항목이 있으면 사용자에게 피드백하고 보완을 요청하세요.**
**모든 항목이 통과할 때까지 검증-보완을 반복하세요.**

### 5.1 완성도 검증

| 검증 항목 | 기준 | 통과 |
|-----------|------|------|
| 필수 섹션 | 1~10장 모두 작성됨 | ✅/❌ |
| 엔티티 정의 | 모든 필드에 타입, 필수여부, 제약조건 있음 | ✅/❌ |
| API 명세 | 모든 엔드포인트에 Request/Response/Errors 있음 | ✅/❌ |
| 에러 정의 | 모든 에러에 코드, HTTP상태, 메시지 있음 | ✅/❌ |

### 5.2 리스크 검증

| 검증 항목 | 기준 | 통과 |
|-----------|------|------|
| 장애 포인트 | 외부 연동별 장애 시나리오 식별됨 | ✅/❌ |
| 복구 방안 | 각 장애에 대한 복구 절차 있음 | ✅/❌ |
| 타임아웃 | 외부 호출에 타임아웃 정책 있음 | ✅/❌ |
| 재시도 | 필요한 작업에 재시도 정책 있음 | ✅/❌ |

### 5.3 보안 검증

| 검증 항목 | 기준 | 통과 |
|-----------|------|------|
| 입력 검증 | 사용자 입력 필드에 검증 규칙 있음 | ✅/❌ |
| 인증/권한 | API별 인증 요구사항 명시됨 | ✅/❌ |
| 민감 데이터 | 민감 데이터 처리 방안 있음 | ✅/❌ |
| 보안 위협 | 주요 보안 위협 식별 및 대응 있음 | ✅/❌ |

### 5.4 테스트 검증

| 검증 항목 | 기준 | 통과 |
|-----------|------|------|
| 단위 테스트 | 주요 비즈니스 로직별 테스트 케이스 있음 | ✅/❌ |
| 통합 테스트 | API 엔드포인트별 테스트 시나리오 있음 | ✅/❌ |
| 에러 케이스 | 에러 상황별 테스트 케이스 있음 | ✅/❌ |
| 장애 테스트 | 외부 연동 장애 시나리오 테스트 있음 | ✅/❌ |

### 5.5 요구사항 검증

| 검증 항목 | 기준 | 통과 |
|-----------|------|------|
| 기능 요구사항 | 도메인 목적에 맞는 기능 정의됨 | ✅/❌ |
| 비기능 요구사항 | 성능, 확장성 목표 수치 있음 | ✅/❌ |
| 제약사항 | 기술적/비즈니스 제약 명시됨 | ✅/❌ |

---

## 6. 검증 결과 피드백

검증 결과를 사용자에게 다음 형식으로 보여주세요:

```markdown
## 스펙 품질 검증 결과

### ✅ 통과 항목
- {항목1}
- {항목2}

### ❌ 보완 필요 항목
1. **{항목}**: {부족한 이유}
   - 추가 질문: {보완을 위한 질문}

2. **{항목}**: {부족한 이유}
   - 추가 질문: {보완을 위한 질문}

---
위 항목들을 보완해주시면 스펙 문서를 업데이트하겠습니다.
```

**보완이 완료되면 다시 검증을 수행하세요. 모든 항목이 통과할 때까지 반복합니다.**

---

## 7. 완료 안내

모든 검증 항목이 통과하면 안내:

```
✅ 스펙 문서가 생성되었습니다: .claude/specs/$ARGUMENTS.md

품질 검증 결과: 모든 항목 통과 ✅

다음 단계:
1. 스펙 문서를 최종 검토하세요
2. /feature $ARGUMENTS 명령으로 구현을 시작하세요
```
