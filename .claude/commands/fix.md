# Fix 커맨드

버그를 수정합니다.

## 입력

- $ARGUMENTS: 도메인 이름 (예: documents, search, embeddings, rag)

## 작업 흐름

```
[0. 브랜치 확인/생성] ←── 긴급도 판단
        ↓
[1. 버그 정보 수집]
        ↓
[2. 관련 코드 파악]
        ↓
[3. 영향 범위 분석]
        ↓
[4. 수정 작업]
        ↓
[5. 빌드 및 검증]
        ↓
[6. 테스트 확인]
        ↓
[7. 문서 최신화] ←── 스펙/코드 불일치 확인 (필수)
        ↓
[8. 커밋 및 PR]
```

---

## 작업 순서

### 0. 브랜치 확인/생성

#### 현재 브랜치 확인
```bash
git branch --show-current
git status
```

#### 긴급도 판단

| 긴급도 | 기준 | 브랜치 전략 |
|--------|------|-------------|
| 긴급 (프로덕션 장애) | 서비스 중단, 데이터 손실 | `hotfix/*` → main 직접 |
| 일반 | 기능 오류, 비정상 동작 | `fix/*` → develop |
| 낮음 | 사소한 버그, UI 오류 | 현재 feature 브랜치에서 |

#### 브랜치 생성

**일반 버그 수정:**
```bash
git checkout develop
git pull origin develop
git checkout -b fix/$ARGUMENTS-{버그설명}
```

**긴급 수정 (hotfix):**
```bash
git checkout main
git pull origin main
git checkout -b hotfix/$ARGUMENTS-{버그설명}
```

**브랜치 네이밍:**
- 일반: `fix/{domain}-{description}`
- 긴급: `hotfix/{domain}-{description}`

### 1. 버그 정보 수집

사용자에게 다음을 질문하세요:

- 어떤 버그인가요? (증상 설명)
- 재현 방법이 있나요?
- 예상 동작 vs 실제 동작은?
- 에러 메시지가 있나요?

### 2. 관련 코드 파악

다음 파일들을 확인하세요:

```
app/domains/$ARGUMENTS/
├── schemas.py
├── service.py
└── repository.py

app/api/v1/$ARGUMENTS.py

tests/
├── unit/domains/test_$ARGUMENTS.py
└── integration/test_$ARGUMENTS_api.py
```

### 3. 영향 범위 분석

버그 수정이 영향을 미칠 수 있는 부분을 파악하세요:

| 확인 항목 | 내용 |
|-----------|------|
| 직접 영향 | 수정할 함수/메서드 |
| 호출자 | 이 함수를 호출하는 코드 |
| 의존성 | 다른 도메인에 영향? |
| 테스트 | 관련 테스트 케이스 |

사용자에게 영향 범위를 보여주고 확인받으세요.

### 4. 수정 작업

버그를 수정하세요:

1. 원인이 되는 코드 수정
2. 필요시 관련 코드도 수정
3. 수정 내용을 사용자에게 설명

### 5. 빌드 및 검증

수정 후 다음을 실행하여 검증:

```bash
# 1. 타입 체크
mypy app/domains/$ARGUMENTS/

# 2. 린트 검사
ruff check app/domains/$ARGUMENTS/

# 3. 수정된 파일 관련 테스트
pytest tests/ -k "$ARGUMENTS" -v
```

**검증 실패 시:**
- 에러 메시지 확인 후 코드 재수정
- 모든 검증 통과할 때까지 반복

### 6. 테스트 확인

| 확인 항목 | 내용 |
|-----------|------|
| 기존 테스트 | 기존 테스트가 통과하는지 확인 |
| 버그 재현 테스트 | 버그를 재현하는 테스트 추가 (권장) |
| 회귀 테스트 | 다른 기능이 깨지지 않았는지 확인 |

### 7. 문서 최신화 (필수)

버그 수정 후 문서 확인 및 업데이트:

| 확인 항목 | 조치 |
|-----------|------|
| 스펙 ↔ 코드 불일치 | 스펙 또는 코드 수정 |
| 에러 케이스 누락 | 스펙 6장에 에러 케이스 추가 |
| 테스트 시나리오 누락 | 스펙 9장에 테스트 케이스 추가 |
| 엣지 케이스 발견 | 스펙 4장에 비즈니스 규칙 보완 |

**버그 원인이 스펙 누락/오류인 경우:**
```markdown
## 스펙 보완 내용

| 섹션 | 추가/수정 내용 |
|------|----------------|
| {섹션} | {내용} |
```

### 8. 커밋 및 PR

#### 커밋
```bash
git add .
git commit -m "fix: $ARGUMENTS {버그 설명}

- 원인: {원인}
- 수정: {수정 내용}"
```

#### PR 생성

**일반 수정 (develop으로):**
```bash
git push -u origin fix/$ARGUMENTS-{버그설명}
```

**긴급 수정 (main으로):**
```bash
git push -u origin hotfix/$ARGUMENTS-{버그설명}
# PR: hotfix/* → main
# 머지 후: main → develop 역머지 필요
```

**PR 템플릿:**
```markdown
## 요약
$ARGUMENTS 버그 수정: {버그 설명}

## 원인
- {버그 원인}

## 수정 내용
- {수정 파일}: {수정 내용}

## 테스트
- [x] 버그 재현 테스트 추가
- [x] 기존 테스트 통과
- [x] 회귀 테스트 확인

## 긴급도
- [ ] 일반 / [ ] 긴급 (hotfix)
```

### 9. 완료 보고

```
✅ 버그 수정 완료

## 브랜치
- fix/$ARGUMENTS-{버그설명}

## 수정 내용
- {수정한 파일}: {수정 내용}

## 원인
- {버그 원인 설명}

## 문서 업데이트
- [x] 스펙 문서 확인/수정 완료

## 다음 단계
1. PR 리뷰 요청
2. develop (또는 main) 브랜치에 머지
3. hotfix인 경우 main → develop 역머지
```

---

## 스펙 문서 수정이 필요한 경우

버그가 스펙과 구현의 불일치로 인한 것이라면:

1. 스펙이 잘못된 경우 → 스펙 수정
2. 구현이 잘못된 경우 → 코드 수정 (이 커맨드)
3. 둘 다 수정 필요 → 스펙 수정 후 코드 수정

스펙 수정이 필요하면 사용자에게 알리고 `.claude/specs/$ARGUMENTS.md` 해당 섹션을 수정하세요.
