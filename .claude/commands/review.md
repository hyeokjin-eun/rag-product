# Review 커맨드

스펙 문서를 기준으로 구현된 코드를 리뷰합니다.

## 입력

- $ARGUMENTS: 도메인 이름 (예: documents, search, embeddings, rag)

## 작업 흐름

```
[1. 스펙 & 코드 로드]
        ↓
[2. 에이전트 검증] ─────────────────────┐
        │                              │
        ├─→ 📋 spec-reviewer          │  병렬 실행
        ├─→ 🔍 code-reviewer          │
        └─→ 🧪 test-reviewer          │
        ↓  ←───────────────────────────┘
[3. 검증 결과 통합]
        ↓
[4. 리포트 생성]
        ↓
[5. 액션 아이템 도출]
```

## 사용 에이전트

| 에이전트 | 파일 | 역할 | 출력 |
|----------|------|------|------|
| Spec Reviewer | `agents/spec-reviewer.md` | 스펙 준수 검증 | 스펙 준수율, 누락/불일치 항목 |
| Code Reviewer | `agents/code-reviewer.md` | 코드 품질 검증 | 품질 점수, Critical/Major/Minor 이슈 |
| Test Reviewer | `agents/test-reviewer.md` | 테스트 커버리지 검증 | 커버리지 %, 누락된 테스트 |

### 에이전트 활용 방법

각 에이전트 가이드 파일의 **검증 프로세스**와 **출력 형식**을 따릅니다:

```
1. agents/spec-reviewer.md 참조
   → 스펙 2~8장과 구현 코드 대조
   → 섹션별 준수율 계산
   → "스펙 준수 검증 결과" 형식으로 출력

2. agents/code-reviewer.md 참조
   → Python 컨벤션, 코드 구조, 보안, 성능 검증
   → Critical/Major/Minor 분류
   → "코드 품질 검증 결과" 형식으로 출력

3. agents/test-reviewer.md 참조
   → 테스트 커버리지 및 품질 검증
   → 누락된 테스트 식별
   → "테스트 커버리지 검증 결과" 형식으로 출력
```

**중요**: 아래 "3. 스펙 준수 검증", "4. 코드 퀄리티 검증", "5. 테스트 코드 검증" 섹션은 **요약본**입니다. 상세한 검증 항목과 출력 형식은 각 에이전트 가이드 파일을 참조하세요.

---

## 작업 순서

### 1. 스펙 문서 로드

`.claude/specs/$ARGUMENTS.md` 파일을 읽으세요.

**스펙 문서가 없는 경우:**
- "스펙 문서가 없습니다. 스펙 없이 일반 코드 리뷰만 진행할까요?" 질문
- 사용자가 원하면 스펙 검증 없이 코드 퀄리티 리뷰만 진행

### 2. 구현 파일 로드

다음 파일들을 읽으세요:

```
app/domains/$ARGUMENTS/
├── schemas.py
├── service.py
└── repository.py (있는 경우)

app/api/v1/$ARGUMENTS.py

app/core/dependencies.py (해당 도메인 관련 부분)

tests/
├── unit/domains/test_$ARGUMENTS.py
└── integration/test_$ARGUMENTS_api.py
```

### 3. 스펙 준수 검증

스펙 문서의 각 섹션과 구현을 대조하여 검증하세요.

#### 3.1 데이터 모델 검증 (스펙 2장)

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 엔티티 필드 | 스펙에 정의된 모든 필드가 schemas.py에 있는가? |
| 필드 타입 | 타입이 스펙과 일치하는가? |
| 필수/선택 | 필수 필드에 Optional 없는가? |
| 제약조건 | Field()에 min_length, max_length, ge, le 등 반영됐는가? |
| 상태값 | Enum으로 정의됐는가? |

#### 3.2 API 검증 (스펙 3장)

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 엔드포인트 | 스펙의 모든 엔드포인트가 구현됐는가? |
| HTTP 메서드 | GET/POST/PUT/DELETE가 스펙과 일치하는가? |
| 경로 | URL 경로가 스펙과 일치하는가? |
| 요청 스키마 | Request 모델이 스펙과 일치하는가? |
| 응답 스키마 | Response 모델이 스펙과 일치하는가? |
| 상태 코드 | 성공/에러 상태 코드가 스펙과 일치하는가? |
| 페이지네이션 | 스펙에 있으면 구현됐는가? |

#### 3.3 비즈니스 로직 검증 (스펙 4장)

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 핵심 규칙 | 스펙의 비즈니스 규칙이 모두 구현됐는가? |
| 검증 규칙 | 입력 검증이 스펙대로 동작하는가? |
| 프로세스 흐름 | 처리 순서가 스펙과 일치하는가? |

#### 3.4 외부 연동 검증 (스펙 5장)

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 도메인 의존성 | 의존성 방향이 규칙을 준수하는가? |
| 인프라 연동 | Qdrant 등 외부 서비스 연동이 구현됐는가? |
| Temporal | 워크플로우가 스펙대로 구현됐는가? |

#### 3.5 에러 처리 검증 (스펙 6장)

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 에러 코드 | 스펙의 모든 에러 코드가 정의됐는가? |
| HTTP 상태 | 에러별 상태 코드가 스펙과 일치하는가? |
| 에러 메시지 | 메시지가 스펙과 일치하는가? |
| 예외 처리 | 적절한 try-except가 있는가? |

---

### 4. 코드 퀄리티 검증

#### 4.1 Python 컨벤션

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| PEP 8 | 네이밍, 들여쓰기, 줄 길이 준수 |
| Type hints | 함수 파라미터와 반환값에 타입 힌트 |
| Docstring | public 함수에 docstring |
| Import 순서 | 표준 라이브러리 → 서드파티 → 로컬 |

#### 4.2 코드 구조

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 단일 책임 | 함수/클래스가 하나의 책임만 갖는가? |
| 중복 코드 | 반복되는 코드가 있는가? |
| 복잡도 | 함수가 너무 길거나 복잡하지 않은가? (20줄 이하 권장) |
| 의존성 주입 | 하드코딩된 의존성이 있는가? |

#### 4.3 보안

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 입력 검증 | 사용자 입력이 검증되는가? |
| SQL Injection | raw query 사용 시 파라미터 바인딩 |
| 민감 정보 | 로그에 민감 정보 노출 없는가? |
| 인증/권한 | 필요한 엔드포인트에 인증이 있는가? |

#### 4.4 성능

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| N+1 쿼리 | 반복문 내 DB 호출이 있는가? |
| 비동기 | async/await가 적절히 사용됐는가? |
| 리소스 정리 | 파일/연결이 적절히 닫히는가? |

---

### 5. 테스트 코드 검증

#### 5.1 테스트 커버리지

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 서비스 메서드 | 모든 public 메서드에 테스트가 있는가? |
| API 엔드포인트 | 모든 엔드포인트에 테스트가 있는가? |
| 성공 케이스 | 정상 동작 테스트가 있는가? |
| 실패 케이스 | 에러 상황 테스트가 있는가? |
| 엣지 케이스 | 경계값, 빈 값 등 테스트가 있는가? |

#### 5.2 테스트 품질

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 격리성 | 외부 의존성이 Mock 처리됐는가? |
| 명확성 | 테스트 이름이 테스트 내용을 설명하는가? |
| Assertion | 적절한 검증이 있는가? (assert 누락 없이) |
| Fixture | 공통 설정이 fixture로 분리됐는가? |

#### 5.3 스펙 기반 테스트 (스펙 8장)

| 검증 항목 | 확인 내용 |
|-----------|-----------|
| 단위 테스트 | 스펙 8.1의 테스트 케이스가 모두 구현됐는가? |
| 통합 테스트 | 스펙 8.2의 시나리오가 모두 구현됐는가? |

---

### 6. 리뷰 리포트 작성

검증 결과를 다음 형식으로 정리하세요:

```markdown
# $ARGUMENTS 도메인 리뷰 리포트

## 요약

| 구분 | 상태 | 점수 |
|------|------|------|
| 스펙 준수 | ✅/⚠️/❌ | /100 |
| 코드 퀄리티 | ✅/⚠️/❌ | /100 |
| 테스트 커버리지 | ✅/⚠️/❌ | /100 |
| **종합** | | **/100** |

## 1. 스펙 준수 검증 결과

### ✅ 통과 항목
- {항목1}
- {항목2}

### ⚠️ 개선 필요
- {항목}: {이유}

### ❌ 미구현/불일치
- {항목}: {스펙 내용} vs {실제 구현}

## 2. 코드 퀄리티 검증 결과

### ✅ 잘된 점
- {항목}

### ⚠️ 개선 권장
- {파일:라인} - {이슈 설명}
  ```python
  # Before
  {현재 코드}

  # After (제안)
  {개선 코드}
  ```

### ❌ 반드시 수정 필요
- {파일:라인} - {이슈 설명}

## 3. 테스트 검증 결과

### 커버리지 현황
| 대상 | 테스트 수 | 상태 |
|------|-----------|------|
| 서비스 메서드 | /개 | ✅/❌ |
| API 엔드포인트 | /개 | ✅/❌ |
| 에러 케이스 | /개 | ✅/❌ |

### ⚠️ 누락된 테스트
- {테스트 케이스 설명}

## 4. 액션 아이템

### 🔴 Critical (반드시 수정)
1. {항목}

### 🟡 Major (수정 권장)
1. {항목}

### 🟢 Minor (개선하면 좋음)
1. {항목}

## 5. 다음 단계

- [ ] Critical 이슈 수정
- [ ] Major 이슈 수정
- [ ] 테스트 추가
- [ ] 재리뷰 요청
```

### 7. 사용자 피드백

리포트를 보여주고 질문하세요:
- 리뷰 결과에 대해 질문이 있으신가요?
- 특정 이슈에 대해 더 자세한 설명이 필요하신가요?
- 수정 작업을 도와드릴까요?