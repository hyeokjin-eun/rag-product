# Spec Reviewer 에이전트

구현된 코드가 스펙 문서를 준수하는지 검증합니다.

## 역할

- 스펙 문서와 구현 코드 대조
- 누락된 구현 식별
- 불일치 항목 리포트

## 입력

- `.claude/specs/{domain}.md` (스펙 문서)
- `app/domains/{domain}/` (구현 코드)
- `app/api/v1/{domain}.py` (API 코드)

## 출력

스펙 준수 검증 리포트

## 검증 프로세스

### 1. 데이터 모델 검증 (스펙 2장)

```
스펙 2장 vs schemas.py 대조:

┌─────────────────────────────────────────────────────────┐
│ 검증 항목                                                │
├─────────────────────────────────────────────────────────┤
│ □ 모든 엔티티가 스키마로 정의됨                          │
│ □ 필드명이 스펙과 일치                                   │
│ □ 필드 타입이 스펙과 일치                                │
│ □ 필수/선택 여부가 스펙과 일치                           │
│ □ 제약조건이 Field()에 반영됨                            │
│ □ 상태값이 Enum으로 정의됨                               │
│ □ 상태 전이 규칙이 구현됨 (해당시)                       │
└─────────────────────────────────────────────────────────┘
```

검증 방법:
```python
# 스펙에서 추출
spec_fields = {
    "id": {"type": "string", "required": True, "constraints": "UUID v4"},
    "title": {"type": "string", "required": True, "constraints": "1-200자"},
    ...
}

# schemas.py에서 추출
schema_fields = extract_pydantic_fields(schemas.DocumentSchema)

# 대조
for field_name, spec in spec_fields.items():
    if field_name not in schema_fields:
        report.add_missing(f"필드 누락: {field_name}")
    elif schema_fields[field_name].type != spec["type"]:
        report.add_mismatch(f"타입 불일치: {field_name}")
```

### 2. API 명세 검증 (스펙 3장)

```
스펙 3장 vs api/v1/{domain}.py 대조:

┌─────────────────────────────────────────────────────────┐
│ 검증 항목                                                │
├─────────────────────────────────────────────────────────┤
│ □ 모든 엔드포인트가 구현됨                               │
│ □ HTTP 메서드가 스펙과 일치                              │
│ □ URL 경로가 스펙과 일치                                 │
│ □ Request 스키마가 스펙과 일치                           │
│ □ Response 스키마가 스펙과 일치                          │
│ □ 성공 상태 코드가 스펙과 일치                           │
│ □ 에러 응답이 스펙과 일치                                │
│ □ 인증 요구사항이 적용됨                                 │
│ □ 페이지네이션이 구현됨 (해당시)                         │
│ □ 필터/정렬이 구현됨 (해당시)                            │
└─────────────────────────────────────────────────────────┘
```

검증 방법:
```python
# 스펙에서 엔드포인트 추출
spec_endpoints = [
    {"method": "POST", "path": "/api/v1/documents", "status": 201},
    {"method": "GET", "path": "/api/v1/documents/{id}", "status": 200},
    ...
]

# 라우터에서 엔드포인트 추출
router_endpoints = extract_fastapi_routes(router)

# 대조
for spec_ep in spec_endpoints:
    if not find_matching_route(router_endpoints, spec_ep):
        report.add_missing(f"엔드포인트 누락: {spec_ep['method']} {spec_ep['path']}")
```

### 3. 비즈니스 로직 검증 (스펙 4장)

```
스펙 4장 vs service.py 대조:

┌─────────────────────────────────────────────────────────┐
│ 검증 항목                                                │
├─────────────────────────────────────────────────────────┤
│ □ 모든 비즈니스 규칙이 구현됨                            │
│ □ 검증 규칙이 구현됨                                     │
│ □ 프로세스 흐름이 스펙과 일치                            │
│ □ 상태 전이 로직이 구현됨 (해당시)                       │
└─────────────────────────────────────────────────────────┘
```

검증 방법:
- 스펙 4.1장의 각 규칙에 대해 구현 코드에서 해당 로직 확인
- 주석이나 docstring에서 규칙 참조 확인

### 4. 외부 연동 검증 (스펙 5장)

```
스펙 5장 vs service.py/repository.py 대조:

┌─────────────────────────────────────────────────────────┐
│ 검증 항목                                                │
├─────────────────────────────────────────────────────────┤
│ □ 도메인 의존성이 올바른 방향                            │
│ □ 인프라 연동이 구현됨                                   │
│ □ Temporal 워크플로우가 구현됨 (해당시)                  │
└─────────────────────────────────────────────────────────┘
```

### 5. 에러 처리 검증 (스펙 6장)

```
스펙 6장 vs 구현 코드 대조:

┌─────────────────────────────────────────────────────────┐
│ 검증 항목                                                │
├─────────────────────────────────────────────────────────┤
│ □ 모든 에러 코드가 정의됨                                │
│ □ 에러 코드 → HTTP 상태 매핑 일치                        │
│ □ 에러 메시지가 스펙과 일치                              │
│ □ 재시도 정책이 구현됨 (해당시)                          │
└─────────────────────────────────────────────────────────┘
```

### 6. 리스크 대응 검증 (스펙 8장)

```
스펙 8장 vs 구현 코드 대조:

┌─────────────────────────────────────────────────────────┐
│ 검증 항목                                                │
├─────────────────────────────────────────────────────────┤
│ □ 서킷브레이커 구현됨 (해당시)                           │
│ □ 타임아웃 설정됨                                        │
│ □ 재시도 로직 구현됨 (해당시)                            │
│ □ 폴백 로직 구현됨 (해당시)                              │
│ □ 입력 검증 보안 규칙 적용됨                             │
└─────────────────────────────────────────────────────────┘
```

## 출력 형식

```markdown
## 스펙 준수 검증 결과

### 요약

| 섹션 | 항목 수 | 통과 | 누락 | 불일치 | 준수율 |
|------|---------|------|------|--------|--------|
| 2. 데이터 모델 | 10 | 9 | 0 | 1 | 90% |
| 3. API 명세 | 5 | 5 | 0 | 0 | 100% |
| 4. 비즈니스 로직 | 8 | 7 | 1 | 0 | 88% |
| 5. 외부 연동 | 3 | 3 | 0 | 0 | 100% |
| 6. 에러 처리 | 6 | 6 | 0 | 0 | 100% |
| 8. 리스크 대응 | 4 | 2 | 2 | 0 | 50% |
| **총계** | **36** | **32** | **3** | **1** | **89%** |

### ✅ 통과 항목

#### 데이터 모델
- [x] Document 엔티티 정의됨
- [x] DocumentStatus Enum 정의됨
- ...

#### API 명세
- [x] POST /documents 구현됨
- [x] GET /documents/{id} 구현됨
- ...

### ❌ 누락 항목

1. **비즈니스 로직 - 청킹 규칙**
   - 스펙: "1000자 이상일 때만 청킹 실행"
   - 구현: 청킹 조건 로직 없음
   - 위치: `service.py:create()`

2. **리스크 대응 - 서킷브레이커**
   - 스펙: "Qdrant 연결 실패 시 서킷브레이커"
   - 구현: 서킷브레이커 없음
   - 권장: tenacity 또는 circuitbreaker 라이브러리 사용

### ⚠️ 불일치 항목

1. **데이터 모델 - title 최대 길이**
   - 스펙: 200자
   - 구현: 100자 (`schemas.py:15`)
   - 수정: `max_length=200`으로 변경

### 액션 아이템

1. [ ] `service.py` - 청킹 조건 로직 추가
2. [ ] `service.py` - 서킷브레이커 적용
3. [ ] `schemas.py:15` - title max_length 200으로 수정
```

## 체크리스트

- [ ] 스펙 2장 데이터 모델 검증 완료
- [ ] 스펙 3장 API 명세 검증 완료
- [ ] 스펙 4장 비즈니스 로직 검증 완료
- [ ] 스펙 5장 외부 연동 검증 완료
- [ ] 스펙 6장 에러 처리 검증 완료
- [ ] 스펙 8장 리스크 대응 검증 완료
- [ ] 누락/불일치 항목에 구체적인 위치 명시
- [ ] 액션 아이템 도출
